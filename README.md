# Lines Changed Summary Action

A GitHub Action that comments on pull requests with a lines changed summary (using GitHub's +/- style), with the ability to ignore files based on pattern matching.

This is useful when you want to get an accurate sense of the PR scope without counting generated files, lock files, or other files that don't meaningfully impact review effort.

## Features

- ðŸ“Š Posts a clean lines changed summary on PRs
- ðŸŽ¯ Ignores files based on configurable patterns (e.g., `**/generated/**`, `*.lock`)
- ðŸ”„ Updates the same comment on each run (no spam)
- ðŸ“ Shows changed and ignored files in collapsible sections
- ðŸ”— All filenames link directly to their diff in the PR
- ðŸ“„ Handles PRs with any number of files (automatic pagination)
- âœ… Validates glob patterns and warns about common mistakes
- âš¡ Fast and lightweight TypeScript implementation

## Usage

### Basic Example

```yaml
name: Lines Changed Summary

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  lines-changed:
    runs-on: ubuntu-latest
    steps:
      - uses: nrutman/lines-changed-gha@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
```

### Ignore Generated Files

```yaml
- uses: nrutman/lines-changed-gha@v1
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    ignore-patterns: |
      **/generated/**,
      **/*.generated.ts,
      **/*.lock,
      **/dist/**
```

### Custom Comment Header

```yaml
- uses: nrutman/lines-changed-gha@v1
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    ignore-patterns: '**/generated/**,**/*.lock'
    comment-header: '## ðŸ“Š Code Changes (excluding generated files)'
```

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `github-token` | GitHub token for API access | Yes | `${{ github.token }}` |
| `ignore-patterns` | Comma-separated list of glob patterns to ignore | No | `''` |
| `comment-header` | Custom header text prepended to the summary | No | None (shows squares and counts only) |

### Pattern Matching

The `ignore-patterns` input accepts glob patterns that follow the [minimatch](https://github.com/isaacs/minimatch) syntax:

- `**/generated/**` - Ignore all files in any `generated` directory
- `**/*.generated.ts` - Ignore all files ending with `.generated.ts`
- `*.lock` - Ignore lock files in the root directory
- `**/*.lock` - Ignore lock files anywhere
- `**/dist/**` - Ignore all files in any `dist` directory

Multiple patterns can be combined with commas:
```yaml
ignore-patterns: '**/generated/**,**/*.lock,**/dist/**'
```

**Pattern Validation:** The action validates your glob patterns and warns about common mistakes:
- Patterns starting with `/` (should be relative)
- Patterns using backslashes instead of forward slashes
- Invalid glob syntax

## Outputs

| Output | Description |
|--------|-------------|
| `added-lines` | Number of lines added (not counting ignored files) |
| `removed-lines` | Number of lines removed (not counting ignored files) |
| `total-files` | Total number of files changed |
| `ignored-files` | Number of files ignored by patterns |

### Using Outputs

```yaml
- uses: nrutman/lines-changed-gha@v1
  id: lines-changed
  with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    ignore-patterns: '**/generated/**'

- name: Check if PR is too large
  if: steps.lines-changed.outputs.added-lines > 500
  run: echo "::warning::This PR adds more than 500 lines"
```

## Example Comment

The action will post a comment like this:

---

## ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¥ðŸŸ¥ **+342** / **-128**

<details>
<summary>Changed (12 files, 85% of changes)</summary>

| File | Lines Added | Lines Removed |
|------|-------------|---------------|
| [`src/components/UserProfile.tsx`](https://github.com/owner/repo/pull/123/files#diff-xyz123) | +45 | -12 |
| [`src/utils/helpers.ts`](https://github.com/owner/repo/pull/123/files#diff-abc789) | +23 | -8 |
| ...

</details>

<details>
<summary>Ignored (3 files, 15% of changes)</summary>

Ignored patterns: `**/generated/**`, `**/*.lock`

| File | Lines Added | Lines Removed |
|------|-------------|---------------|
| [`src/generated/api.ts`](https://github.com/owner/repo/pull/123/files#diff-abc123) | +50 | -5 |
| [`src/generated/types.ts`](https://github.com/owner/repo/pull/123/files#diff-def456) | +20 | -3 |
| [`package-lock.json`](https://github.com/owner/repo/pull/123/files#diff-789abc) | +5 | -0 |

</details>

---
*Generated by [Lines Changed](https://github.com/nrutman/lines-changed-gha) GitHub Action*

---

## Development

> **âš ï¸ Important:** This action requires the `dist/` folder to be committed to the repository. GitHub Actions run the pre-built code directly and do not build the action at runtime.

### Setup

```bash
pnpm install
```

#### Configure Git Hooks (Recommended)

Set up automatic dependency installation for all git operations:

```bash
git config core.hooksPath .githooks
```

This configures three hooks that run `pnpm install` when dependencies change:

**Git Hooks Included:**
- **`post-checkout`** - After `git checkout` or `git switch`
- **`post-merge`** - After `git merge` or `git pull`
- **`post-rewrite`** - After `git rebase`

All hooks are smart: they only run `pnpm install` if `package.json` or `pnpm-lock.yaml` actually changed, preventing unnecessary installations.

### Build

```bash
pnpm build
```

This compiles the TypeScript code and bundles it with dependencies using `esbuild`. Always commit the `dist/` folder after building.

### Ensuring Build Files Are Always Up To Date

The CI workflow includes a dedicated job called **"Verify Build Files Up To Date"** that checks if the committed `dist/` files match the source code. This prevents merging changes when build files are outdated.

#### Enable Branch Protection (Recommended)

To **enforce** that build files are always up to date:

1. Go to your repository **Settings** â†’ **Branches**
2. Add a branch protection rule for `main`
3. Enable **"Require status checks to pass before merging"**
4. Select the following required checks:
   - âœ… **Test, Lint, and Type Check**
   - âœ… **Verify Build Files Up To Date**

This will prevent merging any PR where the build files are out of date.

#### Optional: Pre-commit Hook

You can add a pre-commit hook to automatically rebuild before committing:

```bash
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/sh
echo "Rebuilding action before commit..."
pnpm build
git add dist/
EOF

chmod +x .git/hooks/pre-commit
```

**Note:** This rebuilds on every commit, which may slow down your workflow. The CI check is usually sufficient.

### Testing Locally

To test the action locally, you can use [act](https://github.com/nektos/act) or create a test repository and reference your branch:

```yaml
- uses: nrutman/lines-changed-gha@your-branch-name
```

## Publishing

**Important:** GitHub Actions require the compiled `dist/` folder to be committed to the repository. The action runs the pre-built code directly without building itself.

1. Build the action:
   ```bash
   pnpm build
   ```

2. Commit all changes including the `dist/` folder:
   ```bash
   git add .
   git commit -m "Build action"
   ```

3. Tag and push:
   ```bash
   git tag -a v1 -m "Release v1"
   git push origin main --tags
   ```

**Note:** The CI workflow automatically verifies that the `dist/` folder is up to date on every PR. To prevent merging outdated builds, enable branch protection rules (see Development section above).

## License

MIT
