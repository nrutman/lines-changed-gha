import type { DiffSummary } from './types';
import { COMMENT_IDENTIFIER } from './constants';
import { generateDiffSquares } from './generateDiffSquares';
import { generateFileDiffUrl } from './generateFileDiffUrl';

export function generateCommentBody(
  summary: DiffSummary,
  header: string,
  excludePatterns: string[],
  owner: string,
  repo: string,
  prNumber: number
): string {
  const squares = generateDiffSquares(summary.addedLines, summary.removedLines);

  // Use custom header if provided, otherwise use default format
  const headerText = header
    ? `${header}\n\n${squares} **+${summary.addedLines}** / **-${summary.removedLines}**`
    : `## ${squares} **+${summary.addedLines}** / **-${summary.removedLines}**`;

  let body = `${COMMENT_IDENTIFIER}\n${headerText}\n\n`;

  const totalAddedLines = summary.addedLines + summary.excludedAddedLines;
  const totalRemovedLines = summary.removedLines + summary.excludedRemovedLines;
  const totalChangedLines = totalAddedLines + totalRemovedLines;
  const includedChangedLines = summary.addedLines + summary.removedLines;
  const excludedChangedLines =
    summary.excludedAddedLines + summary.excludedRemovedLines;

  const includedCount = summary.includedFiles.length;
  const excludedCount = summary.excludedFiles.length;

  const includedPercentage =
    totalChangedLines > 0
      ? Math.round((includedChangedLines / totalChangedLines) * 100)
      : 0;
  const excludedPercentage =
    totalChangedLines > 0
      ? Math.round((excludedChangedLines / totalChangedLines) * 100)
      : 0;

  if (includedCount > 0) {
    const includedSummary = `Included (${includedCount} ${includedCount === 1 ? 'file' : 'files'}, ${includedPercentage}% of changes)`;
    body += `<details>\n<summary>${includedSummary}</summary>\n\n`;
    body += '| File | Lines Added | Lines Removed |\n';
    body += '|------|-------------|---------------|\n';

    const sortedFiles = [...summary.includedFiles].sort(
      (a, b) => b.changes - a.changes
    );

    for (const file of sortedFiles) {
      const fileUrl = generateFileDiffUrl(owner, repo, prNumber, file.filename);
      body += `| [\`${file.filename}\`](${fileUrl}) | +${file.additions} | -${file.deletions} |\n`;
    }

    body += '\n</details>\n\n';
  }

  if (excludedCount > 0) {
    const excludedSummary = `Excluded (${excludedCount} ${excludedCount === 1 ? 'file' : 'files'}, ${excludedPercentage}% of changes)`;
    body += `<details>\n<summary>${excludedSummary}</summary>\n\n`;
    body += `The following files were excluded based on patterns: \`${excludePatterns.join('`, `')}\`\n\n`;
    body += `**Total excluded:** +${summary.excludedAddedLines} / -${summary.excludedRemovedLines} lines\n\n`;

    for (const filename of summary.excludedFiles) {
      const fileUrl = generateFileDiffUrl(owner, repo, prNumber, filename);
      body += `- [\`${filename}\`](${fileUrl})\n`;
    }

    body += '\n</details>';
  }

  body += '\n\n---\n';
  body +=
    '*Generated by [Lines Changed](https://github.com/nrutman/lines-changed-gha) GitHub Action*';

  return body;
}
