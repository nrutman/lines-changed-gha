import type { DiffSummary } from './types';
import { COMMENT_IDENTIFIER } from './constants';
import { generateDiffSquares } from './generateDiffSquares';
import { generateFileDiffUrl } from './generateFileDiffUrl';

export function generateCommentBody(
  summary: DiffSummary,
  header: string,
  excludePatterns: string[],
  owner: string,
  repo: string,
  prNumber: number
): string {
  const squares = generateDiffSquares(summary.addedLines, summary.removedLines);

  // Build comment body - icons and counts are always the main header
  let body = `${COMMENT_IDENTIFIER}\n`;

  // Add optional header text above the summary if provided
  if (header) {
    body += `${header}\n\n`;
  }

  body += `## ${squares} **+${summary.addedLines}** / **-${summary.removedLines}**\n\n`;

  const includedChangedLines = summary.addedLines + summary.removedLines;
  const ignoredChangedLines =
    summary.ignoredAddedLines + summary.ignoredRemovedLines;
  const totalChangedLines = includedChangedLines + ignoredChangedLines;

  const includedCount = summary.includedFiles.length;
  const ignoredCount = summary.ignoredFiles.length;

  const includedPercentage =
    totalChangedLines > 0
      ? Math.round((includedChangedLines / totalChangedLines) * 100)
      : 0;
  const ignoredPercentage =
    totalChangedLines > 0
      ? Math.round((ignoredChangedLines / totalChangedLines) * 100)
      : 0;

  if (includedCount > 0) {
    const changedSummary = `Changed (${includedCount} ${includedCount === 1 ? 'file' : 'files'}, ${includedPercentage}% of changes)`;
    body += `<details>\n<summary>${changedSummary}</summary>\n\n`;
    body += '| File | Lines Added | Lines Removed |\n';
    body += '|------|-------------|---------------|\n';

    const sortedFiles = [...summary.includedFiles].sort(
      (a, b) => b.changes - a.changes
    );

    for (const file of sortedFiles) {
      const fileUrl = generateFileDiffUrl(owner, repo, prNumber, file.filename);
      body += `| [\`${file.filename}\`](${fileUrl}) | +${file.additions} | -${file.deletions} |\n`;
    }

    body += '\n</details>\n\n';
  }

  if (ignoredCount > 0) {
    const ignoredSummary = `Ignored (${ignoredCount} ${ignoredCount === 1 ? 'file' : 'files'}, ${ignoredPercentage}% of changes)`;
    body += `<details>\n<summary>${ignoredSummary}</summary>\n\n`;
    body += `The following files were ignored based on patterns: \`${excludePatterns.join('`, `')}\`\n\n`;
    body += `**Total ignored:** +${summary.ignoredAddedLines} / -${summary.ignoredRemovedLines} lines\n\n`;

    for (const file of summary.ignoredFiles) {
      const fileUrl = generateFileDiffUrl(owner, repo, prNumber, file.filename);
      body += `- [\`${file.filename}\`](${fileUrl})\n`;
    }

    body += '\n</details>';
  }

  body += '\n\n---\n';
  body +=
    '*Generated by [Lines Changed](https://github.com/nrutman/lines-changed-gha) GitHub Action*';

  return body;
}
